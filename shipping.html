<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shipping & Delivery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script type="module" src="store-service.js"></script>
    <script type="module">
      import AuthToken from './auth-token.js';
      window.AuthToken = AuthToken;
    </script>
    <script type="module">
  import userId from './user-id.js';
  window.userId = userId;
</script>

    <style>
        :root {
            --primary-blue: #4280FD;
            --text-grey: #474747;
            --text-light: #5F6368;
            --bg-light: #f3f3f5;
            --success-green: #4CAF50;
            --discount-green: #4CAF50;
        }
        
        /* Custom marker style for Leaflet */
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }
        
        #leaflet-map {
            cursor: crosshair !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Baloo 2';
            background: var(--bg-light);
            color: var(--text-grey);
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* HEADER */
        .shipping-header {
            background: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: black;
            font-size: 18px;
            padding: 5px;
        }

        .header-title {
            color: black;
            font-size: 16px;
            font-weight: 600;
        }

        /* DELIVERY TABS */
        .delivery-tabs {
            display: flex;
            background: #fff;
            margin: 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .delivery-tab {
            flex: 1;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            background: #fff;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .delivery-tab.active {
            background: var(--primary-blue);
            color: #fff;
        }

        .delivery-tab i {
            font-size: 14px;
        }

        /* ADDRESS SECTION */
        .address-section {
            background: #fff;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .current-address {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .current-address i {
            color: var(--text-light);
            margin-top: 2px;
        }

        .address-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-grey);
            line-height: 1.4;
        }

        .change-address {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary-blue);
            font-size: 13px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 8px;
            margin-left: 28px;
        }

        .change-address i {
            font-size: 12px;
        }

        /* DELIVERY MODE SECTION */
        .section-container {
            background: #fff;
            margin: 12px 0;
            padding: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-grey);
            margin-bottom: 16px;
        }

        /* DELIVERY OPTIONS */
        .delivery-option {
            display: flex;
            align-items: flex-start;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .delivery-option:last-child {
            border-bottom: none;
        }

        .option-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: var(--text-grey);
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-grey);
            margin-bottom: 4px;
        }

        .option-subtitle {
            font-size: 13px;
            color: var(--text-light);
        }

        .free-delivery-badge {
            display: inline-block;
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-green);
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            margin-top: 8px;
            border: 1px dashed var(--success-green);
        }

        .option-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #d0d0d0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-checkbox.checked {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .option-checkbox i {
            color: #fff;
            font-size: 12px;
            display: none;
        }

        .option-checkbox.checked i {
            display: block;
        }

        /* TIME SLOT */
        .time-slot {
            display: flex;
            align-items: center;
            padding: 12px 0;
        }

        .time-slot-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: var(--text-grey);
        }

        .time-slot-content {
            flex: 1;
        }

        .time-slot-text {
            font-size: 14px;
            color: var(--text-grey);
        }

        .pick-btn {
            color: var(--primary-blue);
            font-size: 13px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* BILL DETAILS */
        .bill-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .bill-label {
            font-size: 14px;
            color: var(--text-grey);
        }

        .bill-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-grey);
        }

        .bill-row.discount .bill-label,
        .bill-row.discount .bill-value {
            color: var(--discount-green);
        }

        .bill-row.total {
            border-top: 1px solid #e0e0e0;
            margin-top: 8px;
            padding-top: 16px;
        }

        .bill-row.total .bill-label,
        .bill-row.total .bill-value {
            font-size: 16px;
            font-weight: 700;
        }

        .delivery-free {
            text-decoration: line-through;
            color: #999;
            margin-right: 8px;
            font-size: 13px;
        }

        .free-text {
            color: var(--success-green);
            font-weight: 700;
        }

        /* FOOTER */
        .checkout-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            z-index: 200;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .footer-price {
            display: flex;
            flex-direction: column;
        }

        .footer-original {
            font-size: 12px;
            color: #999;
            text-decoration: line-through;
        }

        .footer-total {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-grey);
        }

        .footer-items {
            font-size: 12px;
            color: var(--text-light);
        }

        .place-order-btn {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(66, 128, 253, 0.3);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ADDRESS MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .address-modal {
            background: #fff;
            width: 100%;
            max-width: 400px;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-grey);
            margin-bottom: 20px;
        }

        /* SAVED ADDRESS LIST */
        .saved-address {
            display: flex;
            align-items: flex-start;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .saved-address:last-of-type {
            border-bottom: none;
        }

        .address-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #d0d0d0;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .address-radio.selected {
            border-color: var(--primary-blue);
        }

        .address-radio.selected::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--primary-blue);
            border-radius: 50%;
        }

        .saved-address-content {
            flex: 1;
        }

        .saved-address-text {
            font-size: 14px;
            color: var(--text-grey);
            line-height: 1.4;
        }

        .default-badge {
            color: var(--primary-blue);
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
        }

        .address-check {
            width: 22px;
            height: 22px;
            background: var(--primary-blue);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }

        .address-check.visible {
            opacity: 1;
        }

        .address-check i {
            color: #fff;
            font-size: 12px;
        }

        /* ADD ADDRESS FORM */
        .add-address-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .add-address-title {
            color: var(--primary-blue);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-grey);
            margin-bottom: 6px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Baloo 2';
            color: var(--text-grey);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-input::placeholder {
            color: #999;
        }

        /* MODAL BUTTONS */
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            gap: 16px;
        }

        .cancel-btn {
            background: none;
            border: none;
            color: #F44336;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            padding: 12px 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .save-address-btn {
            background: #fff;
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
            font-size: 14px;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* TIME PICKER MODAL */
        .time-modal {
            background: #fff;
            width: 100%;
            max-width: 400px;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px;
            animation: slideUp 0.3s ease;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .time-slot-option {
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot-option:hover {
            border-color: var(--primary-blue);
        }

        .time-slot-option.selected {
            background: rgba(66, 128, 253, 0.1);
            border-color: var(--primary-blue);
        }

        .time-slot-option .time {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-grey);
        }

        .time-slot-option .day {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .confirm-time-btn {
            width: 100%;
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
        }

        /* MAP CONTAINER */
        .map-container {
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .map-container iframe {
            width: 100%;
            height: 150px;
            border: none;
        }

        .map-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
            margin-left: 28px;
        }

        .map-label i {
            color: var(--primary-blue);
        }

        /* ORDER SUCCESS MODAL */
        .order-success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #5BC0EB;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 40px 20px;
        }

        .order-success-overlay.active {
            display: flex;
        }

        .success-confetti {
            position: relative;
            margin-bottom: 40px;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: #fff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .success-icon i {
            font-size: 50px;
            color: #5BC0EB;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .confetti-piece:nth-child(1) { background: #FF6B6B; top: -20px; left: -30px; transform: rotate(45deg); }
        .confetti-piece:nth-child(2) { background: #4ECDC4; top: -30px; right: -20px; transform: rotate(-30deg); }
        .confetti-piece:nth-child(3) { background: #FFE66D; top: 20px; left: -50px; transform: rotate(15deg); }
        .confetti-piece:nth-child(4) { background: #95E1D3; top: -10px; right: -50px; transform: rotate(-45deg); }
        .confetti-piece:nth-child(5) { background: #FF8B94; bottom: -20px; left: -30px; transform: rotate(60deg); }
        .confetti-piece:nth-child(6) { background: #A8E6CF; bottom: 10px; right: -40px; transform: rotate(-15deg); }
        .confetti-piece:nth-child(7) { background: #FFD93D; top: 50px; left: -60px; transform: rotate(30deg); width: 8px; height: 8px; }
        .confetti-piece:nth-child(8) { background: #6BCB77; top: 60px; right: -55px; transform: rotate(-60deg); width: 8px; height: 8px; }
        .confetti-piece:nth-child(9) { background: #FF6B6B; bottom: -30px; right: -20px; transform: rotate(45deg); width: 6px; height: 6px; }
        .confetti-piece:nth-child(10) { background: #4ECDC4; bottom: 30px; left: -45px; transform: rotate(-30deg); width: 6px; height: 6px; }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            text-align: center;
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .success-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            line-height: 1.5;
            max-width: 280px;
            margin-bottom: 40px;
        }

        .back-to-menu-btn {
            background: #fff;
            color: #1aaae8;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="shipping-header">
        <button class="back-btn" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <span class="header-title">Back to cart</span>
    </div>

    <div class="delivery-tabs">
        <button class="delivery-tab active" onclick="switchTab('instore')">
            <i class="fas fa-store-alt"></i> IN-STORE
        </button>
        <button class="delivery-tab" onclick="switchTab('pickup')">
            <i class="fas fa-walking"></i> SELF PICKUP
        </button>
        <button class="delivery-tab" onclick="switchTab('standard')">
            <i class="fas fa-truck"></i> DELIVERY
        </button>
    </div>

    <div class="section-container" id="instore-section">
        <div class="section-title">In-Store Billing</div>
        <p style="font-size: 14px; color: var(--text-light);">Place your order and show your Order ID at the counter. No delivery charges apply.</p>
    </div>

    <div class="section-container" id="self-pickup-section" style="display: none;">
        <div class="section-title">Store Pickup Location</div>
        <div class="current-address">
            <i class="fas fa-map-marker-alt"></i>
            <div class="address-text">
                <strong id="pickup-store-name">Store Name</strong><br>
                <span id="pickup-store-address">Loading store address...</span>
            </div>
        </div>
    </div>

    <div class="address-section" id="standard-delivery-section" style="display: none;">
        <div class="section-title">Delivery Address</div>
        <div class="current-address">
            <i class="fas fa-map-marker-alt"></i>
            <span class="address-text" id="selected-address">No address selected</span>
        </div>
        <button class="change-address" onclick="openAddressModal()">
            <i class="fas fa-plus-circle"></i> Add or Change Address
        </button>
    </div>

    <div class="section-container">
        <div class="section-title">Bill Details</div>
        <div class="bill-row">
            <span>Item Price</span>
            <span>‚Çπ<span id="item-price">0</span></span>
        </div>
        <div class="bill-row" style="color:var(--success-green)">
            <span>Discount (4%)</span>
            <span>-‚Çπ<span id="discount-amount">0</span></span>
        </div>
        <div class="bill-row">
            <span>Delivery Amount</span>
            <span id="delivery-val"><span class="free-text">FREE</span></span>
        </div>
        <div class="bill-row total">
            <span>To Pay</span>
            <span>‚Çπ<span id="total-pay">0</span></span>
        </div>
    </div>

    <div class="checkout-footer">
        <div>
            <div style="font-size:12px; color:#999; text-decoration:line-through">‚Çπ<span id="footer-original">0</span></div>
            <div style="font-size:20px; font-weight:800">‚Çπ<span id="footer-total">0</span></div>
        </div>
        <button class="place-order-btn" onclick="placeOrder()">PLACE ORDER</button>
    </div>

    <div class="modal-overlay" id="address-modal">
        <div class="address-modal">
            <div class="modal-title" style="margin-bottom:15px; font-size:18px">My Addresses</div>
            
            <div id="saved-addresses-list"></div>

            <button onclick="toggleAddAddress()"
        style="width:100%;margin-top:10px;border:none;background:none;
               color:#4280FD;font-weight:700;text-align:left">
‚ûï Add new address
</button>

<div id="add-address-form"
     style="display:none;margin-top:12px;border-top:1px solid #eee;padding-top:15px;">


  <div class="form-group">
    <label class="form-label">Address Line 1</label>
    <input type="text" class="form-input" id="addr1-input" placeholder="House / Flat / Building">
  </div>

  <div class="form-group">
    <label class="form-label">Address Line 2</label>
    <input type="text" class="form-input" id="addr2-input" placeholder="Street, Area, Landmark">
  </div>

  <div style="display:flex; gap:10px">
    <div class="form-group" style="flex:1">
      <label class="form-label">City</label>
      <input type="text" class="form-input" id="city-input">
    </div>

    <div class="form-group" style="flex:1">
      <label class="form-label">Pincode</label>
      <input type="text" class="form-input" id="pin-input" maxlength="6"
             oninput="handlePincode(this.value)">
    </div>
  </div>

  <div style="display:flex; gap:10px">
    <div class="form-group" style="flex:1">
      <label class="form-label">State</label>
      <input type="text" class="form-input" id="state-input">
    </div>

    <div class="form-group" style="flex:1">
      <label class="form-label">Country</label>
      <input type="text" class="form-input" id="country-input" value="India">
    </div>
  </div>

  <!-- Permanent address -->
  <div style="display:flex; align-items:center; gap:10px; margin-top:6px">
    <input type="checkbox" id="permanent-input">
    <label for="permanent-input" style="font-size:14px">
      Set as permanent address
    </label>
  </div>

  <!-- Map button -->
  <button type="button"
          onclick="openMapModal()"
          style="margin-top:12px; width:100%; padding:10px;
                 border:1px solid #4280FD; background:white;
                 color:#4280FD; border-radius:8px; font-weight:700">
    üìç Pick location from map
  </button>

</div>

            
            <div style="display:flex; justify-content:space-between; margin-top:15px">
                <button onclick="closeAddressModal()" style="border:none; background:none; color:red; font-weight:700">CANCEL</button>
                <button onclick="submitNewAddress()" style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:700" id="save-use-btn">SAVE & USE</button>
            </div>
        </div>
    </div>

     <div class="order-success-overlay" id="order-success-modal">
        <div class="success-confetti">
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
        </div>
        <div class="success-title">Congratulations<br>Your order<br>has been accepted</div>
        <div class="success-subtitle">You may now proceed to pay online (or pay on delivery).</div>
        <button class="back-to-menu-btn" onclick="window.parent.closeCart()">BACK TO MENU</button>
    </div>
  <div class="modal-overlay" id="map-modal">
  <div class="address-modal">


        <div class="modal-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>Pick location</span>
            <button id="locate-me-btn" title="Detect my location" style="background:none;border:none;cursor:pointer;font-size:20px;color:#4280FD;display:flex;align-items:center;gap:4px;">
                <i class="fas fa-crosshairs"></i>
            </button>
        </div>

        <div id="leaflet-map" style="height:300px; border-radius:12px; overflow:hidden"></div>

        <div id="geo-error-msg" style="color:#F44336;font-size:13px;margin-top:8px;display:none"></div>

        <div class="form-group" style="margin-top:12px">
            <label class="form-label">Detected address</label>
            <input id="map-address-input" class="form-input" readonly>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:12px">
            <button onclick="closeMapModal()"
                            style="border:none;background:none;color:red;font-weight:700">
                Cancel
            </button>

            <button onclick="closeMapModal()"
                            style="background:#4280FD;color:white;border:none;
                                         padding:10px 20px;border-radius:8px;font-weight:700">
                Done
            </button>
        </div>

  </div>
</div>

    <!-- Leaflet JS for interactive map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
 /* ============================================================
   SHIPPING & DELIVERY LOGIC (FIXED)
   ============================================================ */

let pickedLat = null;
let pickedLng = null;
let leafletMap = null;
let mapMarker = null;

let userAddresses = [];
let selectedAddrId = null;
let currentTab = 'instore'; 

function toggleAddAddress() {
    const el = document.getElementById("add-address-form");
    el.style.display = el.style.display === "none" ? "block" : "none";
}

// --- 1. PINCODE AUTO-FILL ---
async function handlePincode(pin) {
    if (pin.length === 6) {
        try {
            const resp = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
            const data = await resp.json();
            if (data[0].Status === "Success") {
                const post = data[0].PostOffice[0];
                document.getElementById('city-input').value = post.District;
                document.getElementById('state-input').value = post.State;
            }
        } catch (e) { 
            console.error("Pincode lookup error", e); 
        }
    }
}

// --- 2. GET USER ADDRESSES ---
async function fetchUserAddresses() {
    const token = window.AuthToken.get();
    if (!token) return;
    const uid = window.userId.get();
    try {
        const resp = await fetch(`${window.BASE_URL}/api/v1/address/${uid}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (resp.ok) {
    userAddresses = await resp.json();

    // auto select permanent address
    if (!selectedAddrId) {
        const permanent = userAddresses.find(a => a.permanent_address);
        if (permanent) {
            selectedAddrId = permanent.id;
            setSelectedAddressText(permanent);
        }
    }

    renderAddressList();
}

    } catch (e) { 
        console.error("Fetch address error", e); 
    }
}
function setSelectedAddressText(addr) {

    const full =
      `${addr.address_line1}, ${addr.address_line2 || ''}, ` +
      `${addr.city}, ${addr.state} - ${addr.pincode}`;

    document.getElementById('selected-address').textContent =
      full.replace(/,\s*,/g, ',');
}

// --- 3. RENDER ADDRESSES ---
function renderAddressList() {
    const list = document.getElementById('saved-addresses-list');
    if(!list) return;
    list.innerHTML = userAddresses.map(addr => `
        <div class="saved-address" onclick="selectExistingAddress(${addr.id})">
            <div class="address-radio ${selectedAddrId === addr.id ? 'selected' : ''}"></div>
            <div class="saved-address-content">
               <div class="saved-address-text">
  ${addr.address_line1}, ${addr.city} - ${addr.pincode}
  ${addr.permanent_address
    ? `<div class="default-badge">Permanent</div>`
    : ``}
</div>

            </div>
            <i class="fas fa-trash-alt" style="color:#F44336; padding: 10px; cursor: pointer;" 
               onclick="event.stopPropagation(); deleteAddress(${addr.id})"></i>
        </div>
    `).join('');
}

function selectExistingAddress(id) {

    const addr = userAddresses.find(a => a.id === id);
    if (!addr) return;

    selectedAddrId = id;

    setSelectedAddressText(addr);

    renderAddressList();
    closeAddressModal();   // üëà important
}


// --- 4. DELETE ADDRESS ---
async function deleteAddress(id) {
    if (!confirm("Delete this address?")) return;
    const token = window.AuthToken.get();
    const uid = window.userId.get();
    try {
        const resp = await fetch(`${window.BASE_URL}/api/v1/address/${uid}/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (resp.ok) {
            await fetchUserAddresses();
            if (selectedAddrId === id) {
                selectedAddrId = null;
                document.getElementById('selected-address').textContent = "Select a delivery address";
            }
        }
    } catch (e) { alert("Failed to delete address."); }
}

document.addEventListener('DOMContentLoaded', async () => {
    // 1. Run everything immediately in sequence to avoid race conditions
    const cart = loadCartData();
    
    // 2. Initialize the billing UI based on the default 'instore' tab
    updateBillDetails();
    // 3. Fetch remote data (store info/addresses) without blocking the UI
    if (window.StoreService) {
        window.StoreService.getStoreData().then(store => {
            if (store) {
                document.getElementById('pickup-store-name').textContent = store.name;
                document.getElementById('pickup-store-address').textContent = store.address || "Store Location";
            }
        });
        fetchUserAddresses();
    }
});

function loadCartData() {
    let cart = {};
    try {
        if (window.StoreService) {
            cart = window.StoreService.getCart();
        } else {
            const storeId = localStorage.getItem("active_store_id");
            cart = JSON.parse(localStorage.getItem(`cart_${storeId}`)) || {};
        }
    } catch (e) { cart = {}; }

    let subtotal = 0;
    let itemCount = 0;

    Object.values(cart).forEach(item => {
        subtotal += (item.qty * item.price);
        itemCount += item.qty;
    });

    // Update base fields immediately
    const discount = Math.round(subtotal * 0.04); 
    document.getElementById('item-price').textContent = subtotal.toFixed(2);
    document.getElementById('discount-amount').textContent = discount.toFixed(2);
    document.getElementById('footer-original').textContent = subtotal.toFixed(2);

    if (itemCount <= 0) {
        const footer = document.querySelector('.checkout-footer');
        if (footer) footer.style.display = 'none';
    }
    
    return cart;
}

function updateBillDetails() {
    // üî• FIX: Read directly from the variables to ensure we don't get 0 from a slow DOM
    const subtotal = parseFloat(document.getElementById('item-price').textContent || 0);
    const discount = parseFloat(document.getElementById('discount-amount').textContent || 0);
    const itemTotal = subtotal - discount;
    
    let deliveryCharge = (currentTab === 'standard') ? 30 : 0;
    
    const deliveryEl = document.getElementById('delivery-val');
    if (deliveryCharge > 0) {
        deliveryEl.innerHTML = `<span style="color: var(--text-grey); font-weight: 600;">‚Çπ${deliveryCharge.toFixed(2)}</span>`;
    } else {
        deliveryEl.innerHTML = `<span class="free-text">FREE</span>`;
    }

    const finalPrice = itemTotal + deliveryCharge;
    
    // Update the final displays
    document.getElementById('total-pay').textContent = finalPrice.toFixed(2);
    document.getElementById('footer-total').textContent = finalPrice.toFixed(2);
}

/**
 * 6. Updated Tab Switching
 */
function switchTab(tab) {
    currentTab = tab;
    const tabs = document.querySelectorAll('.delivery-tab');
    tabs.forEach(t => t.classList.remove('active'));

    document.getElementById('instore-section').style.display = 'none';
    document.getElementById('self-pickup-section').style.display = 'none';
    document.getElementById('standard-delivery-section').style.display = 'none';

    if (tab === 'instore') {
        tabs[0].classList.add('active');
        document.getElementById('instore-section').style.display = 'block';
    } else if (tab === 'pickup') {
        tabs[1].classList.add('active');
        document.getElementById('self-pickup-section').style.display = 'block';
    } else if (tab === 'standard') {
        tabs[2].classList.add('active');
        document.getElementById('standard-delivery-section').style.display = 'block';
    }

    updateBillDetails(); // Trigger re-calculation of delivery fee
}



/**
 * 8. Final Order Submission
 */
async function placeOrder() {
    const btn = document.querySelector('.place-order-btn');
    const token = window.AuthToken ? window.AuthToken.get() : null;
    
    if (!token) {
        alert("Please login to place an order.");
        return;
    }

    const storeId = window.StoreService.getStoreId();
    const cart = window.StoreService.getCart();
    const items = Object.values(cart).map(item => ({
        product_id: item.id,
        quantity: item.qty
    }));

    const modeMapping = { 'instore': 0, 'pickup': 1, 'standard': 2 };

    const payload = {
        store_id: parseInt(storeId),
        items: items,
        tax: 0,
        delivery_charge: (currentTab === 'standard') ? 30 : 0,
        delivery_mode: modeMapping[currentTab]
    };

    try {
        btn.disabled = true;
        btn.textContent = "PROCESSING...";

        const response = await fetch(`${window.BASE_URL}/api/v1/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            window.StoreService.saveCart({}); // Clear cart for this store
            loadCartData(); // Reload cart and update all bill fields from empty cart
            updateBillDetails(); // Update UI after clearing cart
            document.getElementById('order-success-modal').classList.add('active');
        } else {
            const err = await response.json();
            alert(`Error: ${err.detail || 'Order failed'}`);
            btn.disabled = false;
            btn.textContent = "PLACE ORDER";
        }
    } catch (e) {
        console.error("Order placement error", e);
        alert("Network error.");
        btn.disabled = false;
        btn.textContent = "PLACE ORDER";
    }
}

// Modal Toggle Helpers
function openAddressModal() { document.getElementById('address-modal').classList.add('active'); }
function closeAddressModal() { document.getElementById('address-modal').classList.remove('active'); }

async function submitNewAddress() {

    const btn = document.getElementById("save-use-btn");
    btn.textContent = "SAVING...";

    const token = window.AuthToken.get();

    const payload = {
        lat: pickedLat ?? 0,
        long: pickedLng ?? 0,
        address_line1: document.getElementById('addr1-input').value.trim(),
        address_line2: document.getElementById('addr2-input').value.trim(),
        pincode: document.getElementById('pin-input').value.trim(),
        city: document.getElementById('city-input').value.trim(),
        state: document.getElementById('state-input').value.trim(),
        country: document.getElementById('country-input').value.trim() || "India",
        permanant_address: document.getElementById('permanent-input').checked
    };

    if (!payload.address_line1 || !payload.city || !payload.pincode) {
        alert("Please fill required address fields");
        btn.disabled = false;
        btn.textContent = "SAVE & USE";
        return;
    }

    const uid = await window.userId.wait();

    try {
        const resp = await fetch(`${window.BASE_URL}/api/v1/address/${uid}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });

        if (resp.ok) {
            await fetchUserAddresses();   // reload addresses
            // Get the latest address (assuming it's the last one)
            const addresses = userAddresses || [];
            if (addresses.length > 0) {
                setSelectedAddressText(addresses[addresses.length - 1]);
            }
            closeAddressModal();         // update delivery tab automatically
        }

    } catch (e) {
        alert("Unable to save address");
    }

    btn.disabled = false;
    btn.textContent = "SAVE & USE";
    toggleAddAddress();
}




function selectAddress(index, address) {
    selectedAddressIndex = index;
    document.getElementById('selected-address').textContent = address;
    updateMapForAddress(address);
}

function updateMapForAddress(address) {
    const encodedAddress = encodeURIComponent(address);
    const homeMap = document.getElementById('home-delivery-map');
    if (homeMap) {
        homeMap.src = `https://maps.google.com/maps?q=${encodedAddress}&output=embed`;
    }
}

function openMapModal() {
    document.getElementById('map-modal').classList.add('active');
    setTimeout(initLeafletMap, 200);
}

function initLeafletMap() {
    if (leafletMap) leafletMap.remove();
    leafletMap = L.map('leaflet-map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);

    // Custom icon for user's location
    const userIcon = L.icon({
        iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-icon-2x-blue.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    function setMapToLocation(lat, lng) {
        leafletMap.setView([lat, lng], 16);
        pickedLat = lat;
        pickedLng = lng;
        if (mapMarker) leafletMap.removeLayer(mapMarker);
        // Always use a new marker instance to avoid icon issues
        mapMarker = L.marker([lat, lng], {icon: userIcon}).addTo(leafletMap);
        reverseGeocode(lat, lng);
    }

    function showGeoError(msg) {
        const geoMsg = document.getElementById('geo-error-msg');
        geoMsg.textContent = msg;
        geoMsg.style.display = 'block';
        // Clear address input if error
        document.getElementById('map-address-input').value = '';
    }
    function clearGeoError() {
        const geoMsg = document.getElementById('geo-error-msg');
        geoMsg.textContent = '';
        geoMsg.style.display = 'none';
    }

    // Try to get user's current location
    function tryLocateUser() {
        clearGeoError();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    setMapToLocation(position.coords.latitude, position.coords.longitude);
                    clearGeoError();
                },
                function(error) {
                    let msg = 'Could not detect your location.';
                    if (error.code === 1) msg = 'Location permission denied. Please allow location access.';
                    showGeoError(msg);
                    // Remove marker and clear address if error
                    if (mapMarker) leafletMap.removeLayer(mapMarker);
                    document.getElementById('map-address-input').value = '';
                    pickedLat = null;
                    pickedLng = null;
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        } else {
            showGeoError('Geolocation not supported by your browser.');
            if (mapMarker) leafletMap.removeLayer(mapMarker);
            document.getElementById('map-address-input').value = '';
            pickedLat = null;
            pickedLng = null;
        }
    }

    // Initial attempt
    tryLocateUser();

    // Locate-me button
    setTimeout(() => {
        const btn = document.getElementById('locate-me-btn');
        if (btn) btn.onclick = tryLocateUser;
    }, 0);

    leafletMap.on('click', function(e) {
        pickedLat = e.latlng.lat;
        pickedLng = e.latlng.lng;
        if (mapMarker) leafletMap.removeLayer(mapMarker);
        mapMarker = L.marker([pickedLat, pickedLng], {icon: userIcon}).addTo(leafletMap);
        reverseGeocode(pickedLat, pickedLng);
        clearGeoError();
    });
}

async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        if (data && data.display_name) {
            document.getElementById('map-address-input').value = data.display_name;
        } else {
            document.getElementById('map-address-input').value = '';
        }
    } catch (e) {
        document.getElementById('map-address-input').value = '';
    }
}

function saveMapAddress() {
    const address = document.getElementById('map-address-input').value;
    if (address) {
        document.getElementById('selected-address').textContent = address;
        updateMapForAddress(address);
        closeMapModal();
    }
}

function closeMapModal() {
    document.getElementById('map-modal').classList.remove('active');
}
    </script>
</body>
</html>
