<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Jars n' More - Listerr Edition</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script type="module" src="store-service.js"></script>
  <script type="module">
    import AuthToken from './auth-token.js';
    window.AuthToken = AuthToken;
  </script>
  <script type="module" src="firebase-login.js"></script>
  <script src="phone-helper.js"></script>
  <style>
    :root {
      --listerr-blue: #4280FD;
      --listerr-grey: #474747;
      --light-bg: #f5f7fa;
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Baloo 2';
      background-color: #111;
      margin: 0;
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100dvh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #mobile-container {
      width: 100%;
      height: 100%;
      background: white;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 500px) {
      #mobile-container {
        width: 390px;
        height: 844px;
        max-height: 90vh;
        border-radius: 40px;
        border: 10px solid #222;
        box-shadow: 0 0 60px rgba(0, 0, 0, 0.6);
      }
    }

    .app-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding-top: max(15px, env(safe-area-inset-top));
      padding-left: 10px;
      padding-right: 20px;
      z-index: 2000;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      pointer-events: none;
    }

    .header-left-group {
      display: flex;
      align-items: center;
      width: 60%;
      min-width: 0;
      max-width: 100%;
      gap: 3px;
      flex-wrap: nowrap;
      overflow: hidden;
    }


    .header-logo {
      font-weight: 800;
      font-size: 20px;
      color: white;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
      margin-top: 0px;
      pointer-events: auto;
      margin-left: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-user-img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
      background: #eee;
      pointer-events: auto;
      transition: box-shadow 0.2s;
      margin-right: 0;
    }

    .header-follow-btn {
      background: #fff;
      color: #4280FD;
      border: none;
      border-radius: 18px;
      font-weight: 700;
      font-size: 13px;
      padding: 5px 10px;
      margin-left: 8px;
      white-space: nowrap;
      min-width: 60px;
      max-width: 90px;
      overflow: hidden;
      text-overflow: ellipsis;

      @media (max-width: 500px) {
        .header-left-group {
          width: 60%;
          gap: 3px;
        }

        .header-user-img {
          width: 26px;
          height: 26px;
        }

        .header-logo {
          font-size: 18px;
          margin-left: 4px;
        }

        .header-follow-btn {
          font-size: 12px;
          padding: 4px 7px;
          margin-left: 5px;
          min-width: 48px;
          max-width: 70px;
        }
      }

      box-shadow: 0 2px 8px rgba(66, 128, 253, 0.10);
      cursor: pointer;
      outline: none;
      pointer-events: auto;
      transition: background 0.2s,
      color 0.2s,
      box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .header-follow-btn.following {
      background: #4280FD;
      color: #fff;
      box-shadow: 0 2px 12px rgba(66, 128, 253, 0.18);
      animation: btnPop 0.3s;
    }

    @keyframes btnPop {
      0% {
        transform: scale(1);
      }

      60% {
        transform: scale(1.12);
      }

      100% {
        transform: scale(1);
      }
    }

    .swipe-cta-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 160px;
      z-index: 1500;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: max(30px, env(safe-area-inset-bottom));
      cursor: pointer;
    }

    .swipe-arrow {
      width: 40px;
      height: 5px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .swipe-text {
      color: white;
      font-weight: bold;
      font-size: 16px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {

      0%,
      20%,
      50%,
      80%,
      100% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      60% {
        transform: translateY(-5px);
      }
    }

    #catalog-drawer {
      position: absolute;
      bottom: -100%;
      left: 0;
      width: 100%;
      height: 90%;
      background: #f9f9f9;
      z-index: 3000;
      transition: bottom 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
      border-radius: 25px 25px 0 0;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.3);
    }

    #catalog-drawer.open {
      bottom: 0;
    }

    .catalog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background-color: #FFFFFF;
      border-bottom: 1px solid #eee;
      border-radius: 25px 25px 0 0;
      font-weight: 800;
      font-size: 18px;
      color: var(--listerr-grey);
      flex-shrink: 0;
    }

    .catalog-title {
      font-size: 18px;
      font-weight: 800;
      color: #474747;
      margin: 0;
    }

    .back-btn-catalog,
    .cart-btn-catalog {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
    }

    .cart-container-catalog {
      position: relative;
      cursor: pointer;
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 15px;
      height: 15px;
      background-color: #4280FD;
      color: #FFFFFF;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 50;
    }

    .catalog-content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0;
      -webkit-overflow-scrolling: touch;
    }

    /* Overlay & Login Modal Styles */
    .login-overlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45);
      display: none; align-items: center; justify-content: center;
      z-index: 9999; backdrop-filter: blur(2px);
    }
    .login-card {
      background: #fff; width: 100%; max-width: 360px; border-radius: 18px;
      padding: 28px 22px; box-shadow: 0 16px 40px rgba(0, 0, 0, 0.18);
      animation: slideUp 0.3s ease-out; display: flex; flex-direction: column; align-items: center;
    }
    .login-title { margin: 0; color: #4280FD; font-size: 22px; font-weight: 800; }
    .login-subtitle { margin: 6px 0 20px; font-size: 13px; color: #777; text-align: center; }
    .phone-input {
      display: flex; align-items: center; width: 100%; height: 52px;
      background: #eef5ff; border-radius: 14px; padding: 0 14px; box-sizing: border-box;
    }
    .country-code { font-size: 16px; font-weight: 600; color: #555; margin-right: 8px; }
    .primary-btn {
      width: 100%; padding: 12px; background: #4280FD; color: #fff;
      border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 8px;
    }
    .otp-section { display: none; width: 100%; margin-top: 14px; }
    .otp-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px; }
    .otp-message { min-height: 18px; margin-top: 8px; font-size: 13px; color: #e53935; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .input-box { width: 100%; height: 52px; padding: 0 16px; border-radius: 14px; border: none; background: #eef5ff; font-size: 16px; outline: none; box-sizing: border-box; margin-bottom: 10px; }
    .phone-input input { border: none; background: transparent; padding: 12px; flex: 1; font-size: 16px; outline: none; height: 100%; }
    .recaptcha-box { height: 1px; overflow: hidden; margin-top: 10px; }
  </style>
</head>

<body>
  <div id="mobile-container">

    <div class="app-header">
      <div class="header-left-group">
        <img class="header-user-img" id="store-logo" src="" alt="Store Logo" style="display:none;"
          onload="this.style.display='block'" />

        <div class="header-logo" id="store-name">Loading...</div>

        <button class="header-follow-btn" id="follow-btn" onclick="toggleFollow(this)">Follow</button>
      </div>
    </div>
    <div id="login-modal" class="login-overlay" onclick="hideLoginModal(event)">
      <div class="login-card minimal" onclick="event.stopPropagation()">
        <div class="login-logo">
          <img src="Listerr_logo.png" alt="Logo" class="logo-icon" style="width: 70px; height:70px; object-fit:contain;">
        </div>
        <h2 class="welcome-title">Welcome</h2>
        <p class="welcome-subtitle">Login to your account</p>

        <div id="login-section">
          <input id="login-name" type="text" class="input-box" placeholder="Your name" />
          <div class="phone-input">
            <select id="login-country-code" class="country-code" style="height: 40px; width: 110px; border: none; background: transparent; font-size: 16px; outline: none;">
              <option value="+91" selected>ðŸ‡®ðŸ‡³ +91</option>
              <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
              <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
              <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
              <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
              <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
              <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
              <option value="+92">ðŸ‡µðŸ‡° +92</option>
              <option value="+880">ðŸ‡§ðŸ‡© +880</option>
              <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
              <option value="+7">ðŸ‡·ðŸ‡º +7</option>
              <option value="+33">ðŸ‡«ðŸ‡· +33</option>
              <option value="+39">ðŸ‡®ðŸ‡¹ +39</option>
              <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
              <option value="+62">ðŸ‡®ðŸ‡© +62</option>
            </select>
            <input id="login-phone" type="tel" placeholder="Phone number" maxlength="15" style="min-width: 0;" />
          </div>
          <button class="primary-btn" onclick="sendOTP()">SEND OTP</button>
          <div id="login-message" class="otp-message"></div>
        </div>



        <div id="otp-section" class="otp-section" style="display:none; width:100%;">
          <input id="otp-code" type="text" class="input-box" placeholder="Enter 6-digit OTP" />
          <button class="primary-btn" onclick="handleVerifyOTP()">VERIFY OTP</button>
          <button id="resend-otp-btn" class="primary-btn" style="background:#eee;color:#4280FD;margin-top:8px;" onclick="resendOTP()" disabled>Resend OTP <span id="resend-timer">30</span>s</button>
          <div id="otp-message" class="otp-message"></div>
          <div id="recaptcha-container" class="recaptcha-box"></div>
        </div>
      </div>
    </div>
  <script type="module" src="firebase-login.js"></script>
    <script>
      function startResendTimer() {
  let seconds = 30;
  const timerSpan = document.getElementById('resend-timer');
  const resendBtn = document.getElementById('resend-otp-btn');
  
  const interval = setInterval(() => {
    seconds--;
    if (timerSpan) timerSpan.textContent = seconds;
    
    if (seconds <= 0) {
      clearInterval(interval);
      if (resendBtn) {
        resendBtn.disabled = false;
        resendBtn.innerHTML = 'Resend OTP';
      }
    }
  }, 1000);
}
async function handleVerifyOTP() {
  const msg = document.getElementById('otp-message');
  const otp = document.getElementById('otp-code').value.trim();
  
  if (!window.confirmationResult) {
    msg.textContent = "Please request OTP first.";
    return;
  }
  
  msg.textContent = "Verifying...";
  
  try {
    // 1. Confirm OTP with Firebase
    const result = await window.confirmationResult.confirm(otp);
    const firebase_uid = result.user.uid; // Extract UID from Firebase result
    
    const phone = document.getElementById('login-phone')?.value.trim() || '';
    const code = document.getElementById('login-country-code')?.value || '';
    const name = document.getElementById('login-name')?.value.trim() || 'Guest User';
    const fullPhone = code + phone;
    const baseUrl = window.BASE_URL || '';
    
    // 2. Attempt Login
    let resp = await fetch(baseUrl + '/api/v1/auth/phone-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: fullPhone })
    });

    // 3. Check for 404 - If user doesn't exist, Register them
    if (resp.status === 404) {
      msg.textContent = "Creating account...";
      resp = await fetch(baseUrl + '/api/v1/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: name,
          phone: fullPhone,
          firebase_uid: firebase_uid
        })
      });
    }

    const data = await resp.json().catch(() => ({}));

    // 4. Handle Final Response (from Login or Register)
    if (resp.ok) {
      if (data && data.access_token) {
        AuthToken.set(data.access_token);
      }
      msg.textContent = "Success! Redirecting...";
      const shouldAutoFollow = localStorage.getItem('PENDING_FOLLOW');
      if (shouldAutoFollow === 'true') {
      localStorage.removeItem('PENDING_FOLLOW');
      
      // Call the follow API immediately
      try {
        await fetch(`${window.BASE_URL}/api/v1/stores/${CACHED_STORE_ID}/follow`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${data.access_token}`
          },
          body: JSON.stringify({ store_id: parseInt(CACHED_STORE_ID) })
        });
      } catch (e) {
        console.error("Auto-follow failed", e);
      }
    }
      window.location.href = "index.html";
    } else {
      msg.textContent = data.detail || data.message || "Authentication failed.";
    }
  } catch (err) {
    console.error("OTP Error:", err);
    msg.textContent = "Invalid OTP or connection error. Try again.";
  }
}
/* ========= ======== RESEND OTP ================= */
function resendOTP() {
  const phone = document.getElementById('login-phone').value.trim();
  const code = document.getElementById('login-country-code').value;
  setFirebasePhoneInput(code, phone);
  const btn = document.getElementById('resend-otp-btn');
  const msg = document.getElementById('otp-message');
  if (btn) {
    btn.disabled = true;
    btn.textContent = "SENDINGâ€¦";
  }
  window.sendOTP(function(success) {
    if (success) {
      msg.textContent = "OTP resent successfully!";
      if (btn) {
        btn.innerHTML = 'Resend OTP <span id="resend-timer">30</span>s';
      }
      startResendTimer();
    } else {
      msg.textContent = "Failed to resend OTP. Try again.";
      if (btn) btn.disabled = false;
    }
  });
}
      window.sendOTP = function (callback) {
        const phone = document.getElementById('login-phone').value.trim();
        const code = document.getElementById('login-country-code').value;
        const msg = document.getElementById('login-message');
        const sendBtn = document.querySelector('#login-section .primary-btn');

        if (!phone) {
          msg.textContent = "Please enter phone number";
          return;
        }

        // Show "SENDING..." immediately to fix the perceived delay
        sendBtn.textContent = "SENDING...";
        sendBtn.disabled = true;

        // Prepare hidden field for firebase-login.js
        window.setFirebasePhoneInput(code, phone);
        async function handleVerifyOTP() {
          const msg = document.getElementById('otp-message');
          const otp = document.getElementById('otp-code').value.trim();

          if (!window.confirmationResult) {
            msg.textContent = "Please request OTP first.";
            return;
          }

          msg.textContent = "Verifying...";

          try {
            // 1. Confirm OTP with Firebase
            const result = await window.confirmationResult.confirm(otp);
            const firebase_uid = result.user.uid; // Extract UID from Firebase result

            const phone = document.getElementById('login-phone')?.value.trim() || '';
            const code = document.getElementById('login-country-code')?.value || '';
            const name = document.getElementById('login-name')?.value.trim() || 'Guest User';
            const fullPhone = code + phone;
            const baseUrl = window.BASE_URL || '';

            // 2. Attempt Login
            let resp = await fetch(baseUrl + '/api/v1/auth/phone-login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone: fullPhone })
            });

            // 3. Check for 404 - If user doesn't exist, Register them
            if (resp.status === 404) {
              msg.textContent = "Creating account...";
              resp = await fetch(baseUrl + '/api/v1/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: name,
                  phone: fullPhone,
                  firebase_uid: firebase_uid
                })
              });
            }

            const data = await resp.json().catch(() => ({}));

            // 4. Handle Final Response (from Login or Register)
            if (resp.ok) {
              if (data && data.access_token) {
                AuthToken.set(data.access_token);
              }
              msg.textContent = "Success! Redirecting...";
              window.location.href = "shipping.html";
            } else {
              msg.textContent = data.detail || data.message || "Authentication failed.";
            }
          } catch (err) {
            console.error("OTP Error:", err);
            msg.textContent = "Invalid OTP or connection error. Try again.";
          }
        }

        // Call the Firebase logic (ensure you renamed it in firebase-login.js)
        window.firebaseSendOTP((success) => {
          if (success) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('otp-section').style.display = 'block';
            startResendTimer();
          } else {
            sendBtn.textContent = "SEND OTP";
            sendBtn.disabled = false;
            msg.textContent = "Failed to send OTP.";
          }
          if (callback) callback(success);
        });
      };
      // Cache storeId and BASE_URL globally for instant access
      let CACHED_STORE_ID = null;
      let CACHED_BASE_URL = null;

      document.addEventListener('DOMContentLoaded', async () => {
        // 1. Fetch Data from store-service.js
        const data = await StoreService.getStoreData();

        if (data) {
          // Cache storeId and BASE_URL
          CACHED_STORE_ID = data.id;
          if (window.BASE_URL) {
            CACHED_BASE_URL = window.BASE_URL;
          } else if (window.StoreService && window.StoreService.BASE_URL) {
            CACHED_BASE_URL = window.StoreService.BASE_URL;
          } else {
            try {
              CACHED_BASE_URL = (await import('./store-service.js')).BASE_URL;
            } catch (e) { }
          }

          // A. Update Name & Title
          document.getElementById('store-name').textContent = data.name;
          document.title = data.name + " - Listerr Edition";

          // B. Update Logo
          const logoImg = document.getElementById('store-logo');
          if (data.logo) {
            logoImg.src = data.logo;
          }
          const token = AuthToken.get();
          console.log('AUTH_TOKEN in product.html:', token);
          // C. Update Follow Button Status using API (with BASE_URL)
          const followBtn = document.getElementById('follow-btn');
          try {
            const resp = await fetch(`${CACHED_BASE_URL}/api/v1/stores/${CACHED_STORE_ID}/follow-status`, {
              method: 'GET',
              headers: {
                'Authorization': token ? `Bearer ${token}` : ''
              }
            });
            if (resp.ok) {
              const result = await resp.json();
              if (result && result.is_following === true) {
                console.log('User is following the store');
                followBtn.classList.add('following');
                followBtn.textContent = 'Following';
              } else {
                console.log('User is not following the store');
                followBtn.classList.remove('following');
                followBtn.textContent = 'Follow';
              }
            } else {
              console.log('Failed to fetch follow status');
              followBtn.classList.remove('following');
              followBtn.textContent = 'Follow';
            }
          } catch (e) {
            console.log('Error fetching follow status:', e);
            followBtn.classList.remove('following');
            followBtn.textContent = 'Follow';
          }

        
        }
      });
      // Try to set user image if available (replace with your logic)
      // Example: if you have a user object with photoURL
      if (window.getCurrentUser && window.getCurrentUser()) {
        const user = window.getCurrentUser();
        if (user.photoURL) {
          document.getElementById('headerUserImg').src = user.photoURL;
        }
      }

      // Follow button logic with API integration
      async function toggleFollow(btn) {
        if (!CACHED_STORE_ID || !CACHED_BASE_URL) return;

        const url = `${CACHED_BASE_URL}/api/v1/stores/${CACHED_STORE_ID}/follow`;
        const token = AuthToken.get();
        if (!token) {
          localStorage.setItem('PENDING_FOLLOW', 'true');
          document.getElementById('login-modal').style.display = 'flex';
          return;
        }
        const wasFollowing = btn.classList.contains('following');

        // Helper: revert UI safely
        function revert() {
          if (wasFollowing) {
            btn.classList.add('following');
            btn.textContent = 'Following';
          } else {
            btn.classList.remove('following');
            btn.textContent = 'Follow';
          }
        }

        // Helper: handle 401 not authenticated
        async function handleAuthError(resp) {
          if (resp.status === 401) {
            let data = {};
            try { data = await resp.json(); } catch { }

            if (data.detail === "Not authenticated") {
              alert("Please login to follow this store ðŸšªðŸ”‘");
              // Optional: open your login modal automatically
              document.getElementById('login-modal').style.display = 'flex';
              return true; // means handled
            }
          }
          return false;
        }

        if (wasFollowing) {
          // Optimistic unfollow
          btn.classList.remove('following');
          btn.textContent = 'Follow';

          try {
            const resp = await fetch(url, {
              method: 'DELETE',
              headers: {
                'Authorization': token ? `Bearer ${token}` : ''
              }
            });

            if (await handleAuthError(resp)) {
              revert();
              return;
            }

            if (resp.status !== 200) {
              revert();
            }

          } catch (e) {
            revert();
          }

        } else {
          // Optimistic follow
          btn.classList.add('following');
          btn.textContent = 'Following';

          try {
            const resp = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              },
              body: JSON.stringify({ store_id: parseInt(CACHED_STORE_ID) })
            });

            if (await handleAuthError(resp)) {
              revert();
              return;
            }

            if (resp.status !== 201) {
              revert();
            }

          } catch (e) {
            revert();
          }
        }
      }

    </script>

    <div class="swipe-cta-container" id="swipe-trigger" onclick="openCatalog()">
      <div class="swipe-arrow"></div>
      <div class="swipe-text">View Menu</div>
    </div>


    <amp-story standalone title="Jars n' More" publisher="Jars n' More"
      poster-portrait-src="https://cdn.suvichaar.org/upload/jarsnmore/jarnmore.jpg">
      <amp-story-page id="page1">
        <amp-story-grid-layer template="fill">
          <amp-video id="amp-video-el" layout="fill" poster="https://cdn.suvichaar.org/upload/jarsnmore/jarnmore.jpg"
            autoplay loop>
            <source src="https://cdn.suvichaar.org/upload/jarsnmore/Jar.mp4" type="video/mp4">
          </amp-video>
        </amp-story-grid-layer>
      </amp-story-page>
    </amp-story>

    <div id="catalog-drawer">
      <div class="catalog-header">
        <button class="back-btn-catalog" onclick="handleBack()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="#3C4043" />
          </svg>
        </button>
        <h1 class="catalog-title">Our Menu</h1>
        <div class="cart-container-catalog" onclick="openCart()">
          <i class="fas fa-shopping-bag" style="font-size: 20px; color: #474747;"></i>
          <div class="cart-badge">0</div>
        </div>
      </div>
      <div class="catalog-content"></div>
    </div>

  </div>

  <script src="https://cdn.ampproject.org/v0.js" async></script>
  <script async custom-element="amp-story" src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>
  <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>

  <script>
    // State variable to track if we are inside a product page
    let isProductView = false;

    // 1. Open Menu (Catalog)
    // REPLACE your existing openCatalog function with this:

    function openCatalog() {
      isProductView = false;
      const content = document.querySelector('.catalog-content');
      const drawer = document.getElementById('catalog-drawer');

      // Show Headers
      document.querySelector('.app-header').style.display = 'flex';
      document.querySelector('.catalog-header').style.display = 'flex';

      // Reset Drawer Style
      drawer.style.height = '90%';
      drawer.style.borderRadius = '25px 25px 0 0';

      // FIX: Check if iframe already exists. If not, create it.
      let iframe = content.querySelector('iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.src = "Catalog.html";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "none";
        content.appendChild(iframe);
      } else {
        // If it exists, ensure we are on the Catalog page (not cart/product)
        try {
          if (iframe.contentWindow.location.href.indexOf('Catalog.html') === -1) {
            iframe.contentWindow.location.replace('Catalog.html');
          }
        } catch (e) { iframe.src = "Catalog.html"; }
      }

      drawer.classList.add('open');
      document.getElementById('swipe-trigger').style.display = 'none';
    }

    // 2. Close Logic (The "Smart" Back Button)
    function closeCatalog() {
      if (isProductView) {
        // If product is open, GO BACK TO MENU
        openCatalog();
      } else {
        // If menu is open, CLOSE DRAWER
        document.getElementById('catalog-drawer').classList.remove('open');
        document.getElementById('swipe-trigger').style.display = 'flex';

        // Show Main Header again
        document.querySelector('.app-header').style.display = 'flex';

        setTimeout(() => {
          document.querySelector('.catalog-content').innerHTML = '';
        }, 400);
      }
    }

    // 3. Open Cart
    function openCart() {
      const content = document.querySelector('.catalog-content');

      // 1. Stop container scrolling (iframe handles it)
      content.style.overflow = 'hidden';

      // 2. Hide only the internal "Menu" header
      document.querySelector('.catalog-header').style.display = 'none';

      // 3. Keep Main App Header visible (since we are only 90%)
      document.querySelector('.app-header').style.display = 'flex';

      // 4. Ensure Drawer is 90% with rounded corners
      const drawer = document.getElementById('catalog-drawer');
      drawer.style.height = '90%';
      drawer.style.borderRadius = '25px 25px 0 0';

      content.innerHTML = '<iframe src="cart.html" style="width:100%; height:100%; border:none; display:block; border-radius: 25px 25px 0 0;"></iframe>';
      drawer.classList.add('open');
    }

    // 4. Open Product Page (90% Drawer)


    // 5. Helper function for product.html internal back button
    function closeProduct() {
      openCatalog();
    }

    // 6. Helper for cart.html back button
    function closeCart() {
      openCatalog();
    }

    window.isProductView = false; // default

    function handleBack() {
      const iframe = document.querySelector("#catalog-drawer iframe");

      // ðŸ§  If product page is open, go back to menu only
      if (window.isProductView && iframe) {
        iframe.src = "Catalog.html";   // back to menu
        window.isProductView = false;  // reset state
        return;
      }

      // ðŸšª Otherwise, close the whole catalog drawer
      closeCatalog();
    }

  </script>

</body>

</html>