<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Jars n' More - Listerr Edition</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="store-service.js"></script>
  <style>
    :root {
      --listerr-blue: #4280FD;
      --listerr-grey: #474747;
      --light-bg: #f5f7fa;
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Baloo 2';
      background-color: #111;
      margin: 0;
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100dvh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #mobile-container {
      width: 100%;
      height: 100%;
      background: white;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 500px) {
      #mobile-container {
        width: 390px;
        height: 844px;
        max-height: 90vh;
        border-radius: 40px;
        border: 10px solid #222;
        box-shadow: 0 0 60px rgba(0, 0, 0, 0.6);
      }
    }

    .app-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding-top: max(15px, env(safe-area-inset-top));
      padding-left: 10px;
      padding-right: 20px;
      z-index: 2000;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      pointer-events: none;
    }

    .header-left-group {
      display: flex;
      align-items: center;
      width: 60%;
      min-width: 0;
      max-width: 100%;
      gap: 3px;
      flex-wrap: nowrap;
      overflow: hidden;
    }


    .header-logo {
      font-weight: 800;
      font-size: 20px;
      color: white;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
      margin-top: 0px;
      pointer-events: auto;
      margin-left: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-user-img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
      background: #eee;
      pointer-events: auto;
      transition: box-shadow 0.2s;
      margin-right: 0;
    }

    .header-follow-btn {
      background: #fff;
      color: #4280FD;
      border: none;
      border-radius: 18px;
      font-weight: 700;
      font-size: 13px;
      padding: 5px 10px;
      margin-left: 8px;
      white-space: nowrap;
      min-width: 60px;
      max-width: 90px;
      overflow: hidden;
      text-overflow: ellipsis;

      @media (max-width: 500px) {
        .header-left-group {
          width: 60%;
          gap: 3px;
        }

        .header-user-img {
          width: 26px;
          height: 26px;
        }

        .header-logo {
          font-size: 18px;
          margin-left: 4px;
        }

        .header-follow-btn {
          font-size: 12px;
          padding: 4px 7px;
          margin-left: 5px;
          min-width: 48px;
          max-width: 70px;
        }
      }

      box-shadow: 0 2px 8px rgba(66, 128, 253, 0.10);
      cursor: pointer;
      outline: none;
      pointer-events: auto;
      transition: background 0.2s,
      color 0.2s,
      box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .header-follow-btn.following {
      background: #4280FD;
      color: #fff;
      box-shadow: 0 2px 12px rgba(66, 128, 253, 0.18);
      animation: btnPop 0.3s;
    }

    @keyframes btnPop {
      0% {
        transform: scale(1);
      }

      60% {
        transform: scale(1.12);
      }

      100% {
        transform: scale(1);
      }
    }

    .swipe-cta-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 160px;
      z-index: 1500;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: max(30px, env(safe-area-inset-bottom));
      cursor: pointer;
    }

    .swipe-arrow {
      width: 40px;
      height: 5px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .swipe-text {
      color: white;
      font-weight: bold;
      font-size: 16px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {

      0%,
      20%,
      50%,
      80%,
      100% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      60% {
        transform: translateY(-5px);
      }
    }

    #catalog-drawer {
      position: absolute;
      bottom: -100%;
      left: 0;
      width: 100%;
      height: 90%;
      background: #f9f9f9;
      z-index: 3000;
      transition: bottom 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
      border-radius: 25px 25px 0 0;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.3);
    }

    #catalog-drawer.open {
      bottom: 0;
    }

    .catalog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background-color: #FFFFFF;
      border-bottom: 1px solid #eee;
      border-radius: 25px 25px 0 0;
      font-weight: 800;
      font-size: 18px;
      color: var(--listerr-grey);
      flex-shrink: 0;
    }

    .catalog-title {
      font-size: 18px;
      font-weight: 800;
      color: #474747;
      margin: 0;
    }

    .back-btn-catalog,
    .cart-btn-catalog {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
    }

    .cart-container-catalog {
      position: relative;
      cursor: pointer;
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 15px;
      height: 15px;
      background-color: #4280FD;
      color: #FFFFFF;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 50;
    }

    .catalog-content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body>
  <div id="mobile-container">

    <div class="app-header">
      <div class="header-left-group">
        <img class="header-user-img" id="store-logo" src="" alt="Store Logo" style="display:none;"
          onload="this.style.display='block'" />

        <div class="header-logo" id="store-name">Loading...</div>

<button class="header-follow-btn" id="follow-btn"
  onclick="requireLogin(() => toggleFollow(this))">
  Follow
</button>
      </div>
    </div>

    <script>
      // Helper to always get the latest token
function getAuthToken() {
  const token = window.AUTH_TOKEN || localStorage.getItem("AUTH_TOKEN");
  console.log("[getAuthToken] window.AUTH_TOKEN:", window.AUTH_TOKEN, "localStorage:", localStorage.getItem("AUTH_TOKEN"));
  return token;
}

      // Cache storeId and BASE_URL globally for instant access
      let CACHED_STORE_ID = null;
      let CACHED_BASE_URL = null;

      document.addEventListener('DOMContentLoaded', async () => {
        // 1. Fetch Data from store-service.js
        const data = await StoreService.getStoreData();

        if (data) {
          // Cache storeId and BASE_URL
          CACHED_STORE_ID = data.id;
          if (window.BASE_URL) {
            CACHED_BASE_URL = window.BASE_URL;
          } else if (window.StoreService && window.StoreService.BASE_URL) {
            CACHED_BASE_URL = window.StoreService.BASE_URL;
          } else {
            try {
              CACHED_BASE_URL = (await import('./store-service.js')).BASE_URL;
            } catch (e) {}
          }

          // A. Update Name & Title
          document.getElementById('store-name').textContent = data.name;
          document.title = data.name + " - Listerr Edition";

          // B. Update Logo
          const logoImg = document.getElementById('store-logo');
          if (data.logo) {
            logoImg.src = data.logo;
          }

          // C. Update Follow Button Status using API (with BASE_URL)
          const followBtn = document.getElementById('follow-btn');

try {
  const token = getAuthToken();
  if (!token) throw "No token yet";

  const resp = await fetch(`${CACHED_BASE_URL}/api/v1/stores/${CACHED_STORE_ID}/follow-status`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  if (resp.ok) {
    const result = await resp.json();
    if (result && result.is_following === true) {
      followBtn.classList.add('following');
      followBtn.textContent = 'Following';
    } else {
      followBtn.classList.remove('following');
      followBtn.textContent = 'Follow';
    }
  } else {
    followBtn.classList.remove('following');
    followBtn.textContent = 'Follow';
  }
} catch (e) {
  console.log("Follow status skipped:", e);
  followBtn.classList.remove('following');
  followBtn.textContent = 'Follow';
}


          // D. Inject Video (Correctly for AMP)
          // We must inject the entire amp-video tag to ensure the new source loads
          const videoLayer = document.querySelector('amp-story-grid-layer');
          if (videoLayer && data.video) {
            videoLayer.innerHTML = `
              <amp-video 
                layout="fill" 
                autoplay 
                loop 
                poster="${data.poster || ''}"
                id="dynamic-video">
                <source src="${data.video}" type="video/mp4">
              </amp-video>
            `;
          }
        }
      });
      // Try to set user image if available (replace with your logic)
      // Example: if you have a user object with photoURL
      if (window.getCurrentUser && window.getCurrentUser()) {
        const user = window.getCurrentUser();
        if (user.photoURL) {
          document.getElementById('headerUserImg').src = user.photoURL;
        }
      }

      // Follow button logic with API integration
      async function toggleFollow(btn) {
        // Get store id from StoreService.getStoreData()
        if (!CACHED_STORE_ID || !CACHED_BASE_URL) return;

        const token = getAuthToken();
        if (!token) {
          alert("Please login first");
          return;
        }
        const url = `${CACHED_BASE_URL}/api/v1/stores/${CACHED_STORE_ID}/follow`;
        // Optimistic UI update
        const wasFollowing = btn.classList.contains('following');
        if (wasFollowing) {
          btn.classList.remove('following');
          btn.textContent = 'Follow';
          // Unfollow: send request, expect 200 for success
          try {
            const resp = await fetch(url, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            if (resp.status !== 200) {
              // Revert if failed
              btn.classList.add('following');
              btn.textContent = 'Following';
            }
          } catch (e) {
            // Revert if error
            btn.classList.add('following');
            btn.textContent = 'Following';
          }
        } else {
          btn.classList.add('following');
          btn.textContent = 'Following';
          // Follow: send request, expect 201 for success, 422 for error
          try {
            const resp = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ store_id: parseInt(CACHED_STORE_ID) })
            });
            if (resp.status !== 201) {
              // Revert if failed
              btn.classList.remove('following');
              btn.textContent = 'Follow';
            }
          } catch (e) {
            // Revert if error
            btn.classList.remove('following');
            btn.textContent = 'Follow';
          }
        }
      }

      // Expose a function in index.html to check follow status (for iframe calls)
window.checkFollowStatus = async function() {
  try {
    const followBtn = document.getElementById('follow-btn');
    const token = getAuthToken();
    if (!token) throw "No token yet";
    if (!CACHED_BASE_URL || !CACHED_STORE_ID) return;
    const resp = await fetch(`${CACHED_BASE_URL}/api/v1/stores/${CACHED_STORE_ID}/follow-status`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    if (resp.ok) {
      const result = await resp.json();
      if (result && result.is_following === true) {
        followBtn.classList.add('following');
        followBtn.textContent = 'Following';
      } else {
        followBtn.classList.remove('following');
        followBtn.textContent = 'Follow';
      }
    } else {
      followBtn.classList.remove('following');
      followBtn.textContent = 'Follow';
    }
  } catch (e) {
    console.log("Follow status skipped:", e);
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
      followBtn.classList.remove('following');
      followBtn.textContent = 'Follow';
    }
  }
}
    </script>

    <div class="swipe-cta-container" id="swipe-trigger" onclick="openCatalog()">
      <div class="swipe-arrow"></div>
      <div class="swipe-text">View Menu</div>
    </div>


    <amp-story standalone title="Jars n' More" publisher="Jars n' More"
      poster-portrait-src="https://cdn.suvichaar.org/upload/jarsnmore/jarnmore.jpg">
      <amp-story-page id="page1">
        <amp-story-grid-layer template="fill">
          <amp-video id="amp-video-el" layout="fill" poster="https://cdn.suvichaar.org/upload/jarsnmore/jarnmore.jpg"
            autoplay loop>
            <source src="https://cdn.suvichaar.org/upload/jarsnmore/Jar.mp4" type="video/mp4">
          </amp-video>
        </amp-story-grid-layer>
      </amp-story-page>
    </amp-story>

    <div id="catalog-drawer">
      <div class="catalog-header">
        <button class="back-btn-catalog" onclick="handleBack()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="#3C4043" />
          </svg>
        </button>
        <h1 class="catalog-title">Our Menu</h1>
        <div class="cart-container-catalog" onclick="openCart()">
          <i class="fas fa-shopping-bag" style="font-size: 20px; color: #474747;"></i>
          <div class="cart-badge">0</div>
        </div>
      </div>
      <div class="catalog-content"></div>
    </div>
<script type="module" src="firebase-login.js"></script>
  </div>

  <script src="https://cdn.ampproject.org/v0.js" async></script>
  <script async custom-element="amp-story" src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>
  <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>

  <script>
    
    // State variable to track if we are inside a product page
    let isProductView = false;

    // 1. Open Menu (Catalog)
    function openCatalog() {
      isProductView = false; // We are in the Menu list now

      const content = document.querySelector('.catalog-content');

      // Show Headers
      document.querySelector('.app-header').style.display = 'flex';
      document.querySelector('.catalog-header').style.display = 'flex';

      // Reset Drawer to 90%
      const drawer = document.getElementById('catalog-drawer');
      drawer.style.height = '90%';
      drawer.style.borderRadius = '25px 25px 0 0';

      content.innerHTML = '<iframe src="Catalog.html" style="width:100%; height:100%; border:none;"></iframe>';
      drawer.classList.add('open');
      document.getElementById('swipe-trigger').style.display = 'none';
    }

    // 2. Close Logic (The "Smart" Back Button)
    function closeCatalog() {
      if (isProductView) {
        // If product is open, GO BACK TO MENU
        openCatalog();
      } else {
        // If menu is open, CLOSE DRAWER
        document.getElementById('catalog-drawer').classList.remove('open');
        document.getElementById('swipe-trigger').style.display = 'flex';

        // Show Main Header again
        document.querySelector('.app-header').style.display = 'flex';

        setTimeout(() => {
          document.querySelector('.catalog-content').innerHTML = '';
        }, 400);
      }
    }

    // 3. Open Cart
    function openCart() {

  // üîê If not logged in, stop and show login modal
  if (!window.FirebaseAuth.currentUser && !localStorage.getItem("AUTH_TOKEN")) {
    console.log("üîí Cart access blocked ‚Üí login required");

    // Load cart iframe if not already loaded
    const content = document.querySelector('.catalog-content');
    let cartFrame = content.querySelector('iframe');
    if (!cartFrame || !cartFrame.src.includes('cart.html')) {
      content.innerHTML = `
        <iframe 
          src="cart.html" 
          id="cart-iframe"
          style="width:100%; height:100%; border:none; display:block; border-radius: 25px 25px 0 0;">
        </iframe>
      `;
      cartFrame = content.querySelector('iframe');
    }

    // Wait for iframe to load, then call showLoginModal
    cartFrame.onload = function() {
      if (cartFrame.contentWindow && cartFrame.contentWindow.showLoginModal) {
        cartFrame.contentWindow.showLoginModal();
      } else {
        // Try again after a short delay if not ready
        setTimeout(() => {
          if (cartFrame.contentWindow && cartFrame.contentWindow.showLoginModal) {
            cartFrame.contentWindow.showLoginModal();
          }
        }, 300);
      }
    };
    // If already loaded, call immediately
    if (cartFrame.contentWindow && cartFrame.contentWindow.showLoginModal) {
      cartFrame.contentWindow.showLoginModal();
    }

    // Open the drawer
    const drawer = document.getElementById('catalog-drawer');
    drawer.classList.add('open');
    document.querySelector('.catalog-header').style.display = 'none';
    document.querySelector('.app-header').style.display = 'flex';
    content.style.overflow = 'hidden';
    drawer.style.height = '90%';
    drawer.style.borderRadius = '25px 25px 0 0';
    document.getElementById('swipe-trigger').style.display = 'none';
    return;
  }

  // Already logged in ‚Üí open cart directly
  openCartAfterLogin();
}


function openCartAfterLogin() {

  const content = document.querySelector('.catalog-content');

  // 1. Stop container scrolling (iframe handles it)
  content.style.overflow = 'hidden';

  // 2. Hide only the internal "Menu" header
  document.querySelector('.catalog-header').style.display = 'none';

  // 3. Keep Main App Header visible (since we are only 90%)
  document.querySelector('.app-header').style.display = 'flex';

  // 4. Ensure Drawer is 90% with rounded corners
  const drawer = document.getElementById('catalog-drawer');
  drawer.style.height = '90%';
  drawer.style.borderRadius = '25px 25px 0 0';

  // 5. Load Cart inside iframe
  content.innerHTML = `
    <iframe 
      src="cart.html" 
      style="width:100%; height:100%; border:none; display:block; border-radius: 25px 25px 0 0;">
    </iframe>
  `;

  drawer.classList.add('open');
}


    // 4. Open Product Page (90% Drawer)
    

    // 5. Helper function for product.html internal back button
    function closeProduct() {
      openCatalog();
    }

    // 6. Helper for cart.html back button
    function closeCart() {
      openCatalog();
    }

    window.isProductView = false; // default

function handleBack() {
  const iframe = document.querySelector("#catalog-drawer iframe");

  // üß† If product page is open, go back to menu only
  if (window.isProductView && iframe) {
    iframe.src = "Catalog.html";   // back to menu
    window.isProductView = false;  // reset state
    return;
  }

  // üö™ Otherwise, close the whole catalog drawer
  closeCatalog();
}

  </script>

</body>

</html>