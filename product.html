<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Baloo 2';
            margin: 0;
            padding: 0;
            background: #fff;
            color: #474747;
            padding-bottom: 20px;
        }

        /* IMAGE CAROUSEL SECTION */
        .image-section {
            position: relative;
            width: 100%;
            height: 300px;
            background: #fff;
            margin-bottom: 20px;
            overflow: hidden; /* Hide scrollbars outside */
        }

        /* The Scrolling Track */
        .carousel-track {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            height: 100%;
            width: 100%;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .carousel-track::-webkit-scrollbar { display: none; /* Hide scrollbar Chrome/Safari */ }

        /* Individual Image Wrapper */
        .carousel-item {
            flex: 0 0 100%; /* Takes full width */
            scroll-snap-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .main-img {
            max-height: 250px;
            max-width: 80%;
            object-fit: contain;
        }

        /* GREEN SIDE BADGE */
        .side-badge {
            position: absolute;
            top: 0; right: 0;
            background: #8BC34A; /* Listerr Green */
            color: white;
            width: 40px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 1px;
            border-bottom-left-radius: 5px;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .side-badge i { margin-bottom: 8px; transform: rotate(90deg); }

        /* DOTS */
        .dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 6px;
            z-index: 10;
        }
        .dot { 
            width: 8px; height: 8px; 
            background: #e0e0e0; 
            border-radius: 50%; 
            transition: background 0.3s;
        }
        .dot.active { background: #555; }

        /* CONTENT */
        .content { padding: 0 20px; }

        .title-row {
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        
        .p-title { font-size: 20px; font-weight: 700; line-height: 1.2; width: 85%; }
        
        .share-btn { 
            color: #555; 
            font-size: 20px; 
            cursor: pointer; 
            padding: 5px;
        }
        .share-btn:active { transform: scale(0.9); }

        .p-volume { font-size: 14px; color: #888; margin-top: 4px; margin-bottom: 16px; }

        /* PRICE & ADD ROW */
        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .price-block { display: flex; flex-direction: column; }
        .price-label { font-size: 14px; font-weight: 600; color: #333; }
        .current-p { font-size: 18px; font-weight: 700; color: #333; }
        .mrp { font-size: 12px; color: #999; text-decoration: line-through; }

        .add-btn-lg {
            background: #4280FD;
            color: white;
            border: none;
            padding: 10px 40px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(66, 128, 253, 0.3);
        }

        /* QTY CONTROL (Same as Menu) */
        .qty-control-lg {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            border: 2px solid #4280FD;
            border-radius: 8px;
            padding: 8px 20px;
            background: #fff;
        }

        .qty-btn-lg {
            background: none;
            border: none;
            color: #4280FD;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            padding: 0 8px;
        }

        .qty-btn-lg:active {
            transform: scale(0.9);
        }

        .qty-value-lg {
            font-size: 18px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
            color: #333;
        }

        .sold-by {
            font-size: 13px; color: #666;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }
        .sold-link { color: #4280FD; font-weight: 600; text-decoration: none; }

        /* INFO TABLE */
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #555; }

        .info-table { width: 100%; border-collapse: collapse; }
        .info-table td {
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid #f9f9f9;
        }
        .info-label { color: #888; width: 40%; }
        .info-val { color: #333; font-weight: 500; text-align: right; }

        .disclaimer {
            margin-top: 30px;
            font-size: 11px;
            color: #aaa;
            line-height: 1.4;
        }
    </style>
</head>
<body>
<script type="module">
</script>

    <div class="image-section">
        <div class="side-badge">
             <span>Listerr</span> 
             <i class="fas fa-leaf" style="margin-bottom:10px; transform: rotate(0deg);"></i>
        </div>
        
        <div class="carousel-track" id="track">
            </div>
        
        <div class="dots" id="dots-container">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <div class="content">
        <div class="title-row">
            <div class="p-title" id="p-name">Loading...</div>
            <i class="fas fa-share-alt share-btn" onclick="shareProduct()"></i>
        </div>
        <div class="p-volume">1 Unit</div>

        <div class="action-row">
            <div class="price-block">
                <span class="price-label">Listerr Price: <span id="p-price">‚Çπ0</span></span>
                <span class="mrp">MRP: <span id="p-mrp">‚Çπ0</span></span>
            </div>
            <div id="add-control-container">
                <button class="add-btn-lg" onclick="addToCartFromPage()">ADD</button>
            </div>
        </div>

        <div class="sold-by">
            Sold by <a href="#" class="sold-link">JARS N' MORE</a>
        </div>

        <div class="section-title">More Information</div>
        <table class="info-table">
            <tr>
                <td class="info-label">Shelf Life</td>
                <td class="info-val">3 Days</td>
            </tr>
            <tr>
                <td class="info-label">Unit</td>
                <td class="info-val">Piece (Pc)</td>
            </tr>
            <tr>
                <td class="info-label">Brand</td>
                <td class="info-val">Jars n' More</td>
            </tr>
            <tr>
                <td class="info-label">Type</td>
                <td class="info-val">Fresh Bakery</td>
            </tr>
        </table>

        <div class="disclaimer">
            Product images shown are for representative purposes only. 
            Actual products may vary. Please read product labels carefully before consuming.
        </div>
    </div>

    <script type="module" src="store-service.js"></script>


<script>
  let product = null;
async function syncProductCartFromServer() {
  const token = AuthToken.get();
  if (!token) return;

  try {
    const resp = await fetch(window.BASE_URL + '/api/v1/cart', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!resp.ok) return;

    const data = await resp.json();

    const localCart = {};
    data.items.forEach(item => {
      localCart[item.name] = {
        id: item.product_id,
        price: item.price,
        qty: item.quantity,
        img: item.image
      };
    });

    window.StoreService.saveCart(localCart);

  } catch {}
}

  document.addEventListener('DOMContentLoaded', function () {


    // If inside iframe, set isProductView = true in parent immediately
    if (window.parent && window.parent !== window) {
      try {
        window.parent.isProductView = true;
        console.log("[ProductPage] Setting isProductView = true in parent window");
      } catch (e) {
        console.warn("[ProductPage] Could not set isProductView in parent:", e);
      }
    }

    const data = localStorage.getItem('selected_product');
    if (!data) {
      console.error("No product data found in localStorage");
      document.getElementById('p-name').textContent = "Product not found";
      return;
    }

    product = JSON.parse(data);
    // üî• Restore store context for cart isolation
if (product.store_id) {
  localStorage.setItem("active_store_id", product.store_id);
}
    
    console.log("[ProductPage] Loaded product:", product);

    /* ---------- BASIC FIELDS ---------- */
    document.getElementById('p-name').textContent = product.name;
    document.getElementById('p-price').textContent = `‚Çπ${product.price}`;
    window.CURRENT_PRODUCT_ID = product.id;   // ‚≠ê THIS LINE IS CRITICAL
    const mrpEl = document.getElementById('p-mrp');
    if (mrpEl) {
      mrpEl.textContent = product.mrp ? `‚Çπ${product.mrp}` : '';
      mrpEl.style.display = product.mrp ? 'inline' : 'none';
    }

    // Unit (top)
    const volumeEl = document.querySelector('.p-volume');
    if (volumeEl) {
      volumeEl.textContent = product.unit || '1 Unit';
    }

    // ---------- IMAGE ----------
    const track = document.getElementById('track');
    const dots = document.getElementById('dots-container');

    if (track) {
      track.innerHTML = `
        <div class="carousel-item">
          <img src="${product.image}" class="main-img"
               onerror="this.src='fallback.jpeg'">
        </div>
      `;
    }

    if (dots) {
      dots.innerHTML = `<div class="dot active"></div>`;
    }

    // ---------- SOLD BY (store name) ----------
    const soldLink = document.querySelector('.sold-link');
    if (soldLink) {
      soldLink.textContent = product.store_name || '‚Äî';
    }

    // ---------- INFO TABLE ----------
    const infoRows = document.querySelectorAll('.info-table tr');

    // Shelf Life row (1st)
    if (infoRows[0]) {
      infoRows[0].querySelector('.info-val').textContent =
        product.shelf_life || '‚Äî';
    }

    // Unit row (2nd)
    if (infoRows[1]) {
      infoRows[1].querySelector('.info-val').textContent =
        product.unit || '‚Äî';
    }

    // Brand row (3rd) ‚Üí store name
    if (infoRows[2]) {
      infoRows[2].querySelector('.info-val').textContent =
        product.store_name || '‚Äî';
    }

    // Type row (4th) ‚Üí category name
if (infoRows[3]) {
  infoRows[3].querySelector('.info-val').textContent =
    product.category || '‚Äî';
}


(async function() {
  await syncProductCartFromServer();
  renderAddControl();
  updateCartBadge();
})();


  });

  /* =========================================
     CART UI
  ========================================= */

  function renderAddControl() {

    if (!product) return;
    if (!window.StoreService) return;

    const cart = window.StoreService.getCart();
    const qty = cart[product.name]?.qty || 0;

    const container = document.getElementById('add-control-container');
    if (!container) return;

    if (qty > 0) {
      container.innerHTML = `
        <div class="qty-control-lg">
          <button class="qty-btn-lg" onclick="updateQty(-1)">‚àí</button>
          <span class="qty-value-lg">${qty}</span>
          <button class="qty-btn-lg" onclick="updateQty(1)">+</button>
        </div>`;
    } else {
      container.innerHTML = `
        <button class="add-btn-lg" onclick="addToCartFromPage()">ADD</button>`;
    }
  }

async function updateQty(delta) {
  if (!product) return;

const localCart = window.StoreService.getCart();
const currentQty = localCart[product.name]?.qty || 0;

  const newQty = currentQty + delta;

  try {
    if (newQty <= 0) {
      await removeItem(product.id);
    } else {
      await updateItem(product.id, newQty);
    }
const localCart = window.StoreService.getCart();

if (newQty <= 0) {
  delete localCart[product.name];
} else {
  localCart[product.name] = {
    id: product.id,
    price: product.price,
    qty: newQty,
    img: product.image
  };
}

window.StoreService.saveCart(localCart);
renderAddControl();
updateCartBadge();


  } catch (e) {
    alert("Cannot update quantity ‚ùå");
  }
}


async function addToCartFromPage() {
  const pid = window.CURRENT_PRODUCT_ID;

  if (!pid || pid <= 0) {
    alert("Invalid product ‚ùå Cannot add to cart");
    console.error("‚ùå Missing product id:", pid);
    return;
  }

  try {
    await addItem(pid, 1);   // üî• USE OFFICIAL API LAYER
    alert("Added to cart üõí‚úÖ");
  } catch (e) {
    console.error("Add to cart failed:", e);
    alert("Login required or cannot add ‚ùå");
  }
}




  /* =========================================
     SHARE PRODUCT
  ========================================= */

  window.shareProduct = function () {

    if (!product) {
      alert("Product not loaded yet");
      return;
    }

    const shareText = `${product.name}\n‚Çπ${product.price}\n${product.unit || ''}`;

    if (navigator.share) {
      navigator.share({
        title: product.name,
        text: shareText,
        url: window.location.href
      }).catch(() => {});
    } else {
      const textToCopy = `${product.name} - ‚Çπ${product.price}\n${window.location.href}`;
      navigator.clipboard.writeText(textToCopy);
      alert("Product link copied!");
    }
  };

  /* =========================================
   CART BADGE SYNC
========================================= */

function updateCartBadge() {

  if (!window.StoreService) return;

  const cart = window.StoreService.getCart();
  const count = Object.values(cart).reduce((a, b) => a + b.qty, 0);

  try {
    // If inside iframe
    if (window.parent && window.parent !== window) {
      const badge = window.parent.document.querySelector('.cart-badge');
      if (badge) badge.textContent = count;
    }

    // If same page has badge
    const localBadge = document.querySelector('.cart-badge');
    if (localBadge) localBadge.textContent = count;

  } catch (e) {
    // Cross-origin safety
  }
}
</script>


</body>
</html>